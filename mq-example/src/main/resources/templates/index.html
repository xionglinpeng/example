<!DOCTYPE html>
<html lang="zh_CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>activemq ajax</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"/>


    <script type="text/javascript" th:src="@{/lib/jquery/jquery-1.4.2.min.js}" src="../static/lib/jquery/jquery-1.4.2.min.js"></script>


<!--
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
-->
<!--
    <script type="text/javascript" src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
-->
    <script type="text/javascript" th:src="@{/lib/activemq/amq_jquery_adapter.js}"src="../static/lib/activemq/amq_jquery_adapter.js"></script>
    <script type="text/javascript" th:src="@{/lib/activemq/amq.js}" src="../static/lib/activemq/amq.js"></script>

</head>
<body>
    <div class="container">
        <div class="panel panel-default">
            <div class="panel-heading">ActiveMQ AJAX</div>
            <div class="panel-body">
                <textarea class="form-control" id="message"></textarea>
                <button class="btn btn-primary btn-block" onclick="sendMessage()">发送</button>
                <div class="row">
                    <div class="col-xs-12">
                        <button class="btn btn-success btn-block" id="appPack">应用打包</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        let amq = org.activemq.Amq;
        console.log(amq);

        let clientId = (new Date()).getTime().toString();

        amq.init({
            uri: '/amq',
            logging: true,
            timeout: 20,
            clientId:clientId,
            pollDelay:2
        });

        let id = 'myid1';
        let destination = 'topic://AJAX-TEST';
        let messageListener = function (data) {
            console.log(data)
            let text = data.data,disabled = true;
            if(text === 'await'){
                text = '等待中';
            }else if(text === 'packaging'){
                text = '打包中0%';
            }else if(text === 'packaging20'){
                text = '打包中20%';
            }else if(text === 'packaging40'){
                text = '打包中40%';
            }else if(text === 'packaging60'){
                text = '打包中60%';
            }else if(text === 'packaging80'){
                text = '打包中80%';
            }else if(text === 'packaging100'){
                text = '打包中100%';
            }else if(text === 'success'){
                text = '打包完成';
                disabled = false;
            }
            $("#appPack").text(text).attr('disabled',disabled);
        };




        amq.addListener(clientId,destination,messageListener);

        let sendMessage = function () {
            // let message = $("#message").val();

            let messages = ['await','packaging','packaging20','packaging40','packaging60','packaging80','packaging100','success'];

            let i = 0,len = messages.length;
            let index = setInterval(function () {
                amq.sendMessage(destination,messages[i++]);
                if(i === len){
                    clearInterval(index);
                }
            },3000);


            // $.get('/activemq/text?textMessage='+message,function (result) {
            //     if(result.status === 'success'){
            //         alert('success');
            //     }
            // })
        }

    </script>
</body>
</html>